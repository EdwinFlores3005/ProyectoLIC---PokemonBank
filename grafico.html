<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pokémon Bank — Gráfico</title>

  <!-- Estilos base -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/estilo.css" rel="stylesheet">

  <!-- Chart.js para el gráfico -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body class="bg-body-tertiary"
  style="font-family: Poppins, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial">

  <!-- Barra superior con navegación -->
  <header class="border-bottom bg-white">
    <div class="container d-flex align-items-center justify-content-between py-3">
      <div class="d-flex align-items-center gap-3">
        <img
          src="https://archives.bulbagarden.net/media/upload/thumb/a/a3/Pok%C3%A9mon_Bank_logo.png/800px-Pok%C3%A9mon_Bank_logo.png"
          alt="Pokémon Bank" style="height:36px">
        <strong>Resumen visual</strong>
      </div>
      <nav class="d-flex align-items-center gap-2">
        <a href="acciones.html" class="btn btn-sm btn-outline-secondary">Acciones</a>
        <a href="historial.html" class="btn btn-sm btn-outline-secondary">Historial</a>
        <a href="index.html" class="btn btn-sm btn-dark">Cerrar sesión</a>
      </nav>
    </div>
  </header>

  <main class="py-4">
    <div class="container">

      <!-- Filtros simples -->
      <section class="mb-3">
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-body">
            <form class="row g-2 align-items-end">
              <div class="col-6 col-md-3">
                <label class="form-label">Rango</label>
                <select id="rango" class="form-select">
                  <option value="30">Últimos 30 días</option>
                  <option value="90">Últimos 90 días</option>
                  <option value="365">Último año</option>
                </select>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Tipo de gráfico</label>
                <select id="tipo" class="form-select">
                  <option value="bar">Barras</option>
                  <option value="doughnut">Dona</option>
                </select>
              </div>
              <div class="col-12 col-md-3 d-grid">
                <button id="btnAplicar" type="button" class="btn btn-brand">Aplicar</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Tarjeta con el gráfico -->
      <section>
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h2 class="h6 m-0">Distribución por tipo de transacción</h2>
            </div>

            <!-- Lienzo donde Chart.js dibuja -->
            <div class="p-2">
              <canvas id="grafico" height="110"></canvas>
            </div>

            <!-- Leyenda complementaria -->
            <div class="row text-center mt-3 g-2">
              <div class="col-6 col-md-3"><small class="text-muted d-block">Depósitos</small><span class="fw-semibold"
                  id="nDepositos">0</span></div>
              <div class="col-6 col-md-3"><small class="text-muted d-block">Retiros</small><span class="fw-semibold"
                  id="nRetiros">0</span></div>
              <div class="col-6 col-md-3"><small class="text-muted d-block">Pagos</small><span class="fw-semibold"
                  id="nPagos">0</span></div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <script>
    // Colores para cada tipo de transacción
    const colores = {
      depositos: '#22c55e', // verde
      retiros: '#ef4444', // rojo
      pagos: '#f59e0b'  // amarillo
    };

    // Referencias al DOM
    const ctx = document.getElementById('grafico').getContext('2d');
    const nDepositos = document.getElementById('nDepositos');
    const nRetiros = document.getElementById('nRetiros');
    const nPagos = document.getElementById('nPagos');

    const selRango = document.getElementById('rango');   // select de rango
    const selTipo = document.getElementById('tipo');    // select de tipo de gráfico
    const btnAplicar = document.getElementById('btnAplicar');

    let grafico = null; // aquí guardo el gráfico actual

    // Lee transacciones desde localStorage
    function cargarTransacciones() {
      const data = localStorage.getItem("transacciones");
      return data ? JSON.parse(data) : [];
    }

    // Cuenta depósitos / retiros / pagos dentro del rango seleccionado
    function obtenerDatosDesdeTransacciones(rangoDias) {
      const transacciones = cargarTransacciones();

      const ahora = new Date();
      const limite = new Date(ahora.getTime() - rangoDias * 24 * 60 * 60 * 1000);

      const resultado = {
        depositos: 0,
        retiros: 0,
        pagos: 0
      };

      transacciones.forEach(t => {
        if (!t.fecha) return;

        const fechaT = new Date(t.fecha);
        if (fechaT < limite) return; // fuera del rango, la salto

        const tipo = (t.tipo || "").toLowerCase();

        if (tipo.includes("depósito")) {
          resultado.depositos++;
        } else if (tipo.includes("retiro")) {
          resultado.retiros++;
        } else if (tipo.includes("pago")) {
          resultado.pagos++;
        }
      });

      return resultado;
    }

    // Actualiza los numeritos de abajo
    function actualizarTotales(data) {
      nDepositos.textContent = data.depositos;
      nRetiros.textContent = data.retiros;
      nPagos.textContent = data.pagos;
    }

    // Configuración del gráfico según el tipo (barras o dona)
    function getConfig(tipoGrafico, data) {
      const etiquetas = ['Depósitos', 'Retiros', 'Pagos'];
      const valores = [data.depositos, data.retiros, data.pagos];
      const fondos = [colores.depositos, colores.retiros, colores.pagos];

      if (tipoGrafico === 'doughnut') {
        // Gráfico de dona
        return {
          type: 'doughnut',
          data: {
            labels: etiquetas,
            datasets: [{
              data: valores,
              backgroundColor: fondos
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' }
            },
            cutout: '60%'
          }
        };
      }

      // Gráfico de barras (por defecto)
      return {
        type: 'bar',
        data: {
          labels: etiquetas,
          datasets: [{
            data: valores,
            backgroundColor: fondos,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          }
        }
      };
    }

    // Esta función se llama cada vez que queremos “refrescar” el gráfico
    function actualizarGrafico() {
      const rangoDias = parseInt(selRango.value, 10) || 30;   // 30, 90 o 365
      const tipo = selTipo.value || 'bar';               // 'bar' o 'doughnut'

      const datos = obtenerDatosDesdeTransacciones(rangoDias);

      // Si ya había un gráfico dibujado, lo destruyo antes de crear otro
      if (grafico) {
        grafico.destroy();
      }

      grafico = new Chart(ctx, getConfig(tipo, datos));
      actualizarTotales(datos);
    }

    // Cuando cargue la página
    document.addEventListener("DOMContentLoaded", () => {
      // Pinta el gráfico inicial con los valores por defecto de los selects
      actualizarGrafico();

      // Botón "Aplicar" vuelve a generar el gráfico con lo seleccionado
      if (btnAplicar) {
        btnAplicar.addEventListener("click", (e) => {
          e.preventDefault();
          actualizarGrafico();
        });
      }

    });
  </script>




  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>